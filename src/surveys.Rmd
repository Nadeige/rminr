---
title: "Analysing survey data"
author: "Paul Sharpe, Sophie Homer, Andy Wills"
output: html_document
---

```{r setup, include=FALSE}
## DEVELOPERS: Uncomment one option, as appropriate

## Show only commands.
## knitr::opts_chunk$set(echo = TRUE, message = FALSE, results='hide', fig.keep = 'none', comment=NA)

## Show commands and output.
knitr::opts_chunk$set(echo = TRUE, comment=NA, cache = TRUE)
options(tibble.width = Inf) # show all columns in output
```

# Contents

- [Introduction](#intro)

- [Getting started](#start)

- [Preprocessing](#preprocessing)

- [Reverse scoring survey items](#reverse)

- [Calculating survey scores](#score)

- [Calculating Cronbach’s alpha](#cronbach)

- [Comparing baseline scores between conditions (one-way ANOVA)](#baseline)

- [Comparing scores before and after an intervention (within-between ANOVA)](#prepost)

<a name="intro"></a>

# Introduction

A wide range of psychological constructs are measured using surveys. A survey is a set of questions designed to measure a specific construct, for example self-esteem. Answers to survey questions are often Likert scales. These allow a participant to express how much they agree or disagree with a particular statement e.g. 0=Not at all, 1=A little, 2=Somewhat, 3=A lot, 4=Extremely. A participant's answers are used to calculate a score which measures the construct, e.g. level of depression. The questions themsleves are carefully chosen, often using a method called factor analysis. This ensures that the scale is a valid and relible. A scale is valid if it is a true measure of the construct, in this example it accurately reflects levels of self-esteeem, rather than something else. TODO explain internal and external reliability.

In this worksheet, we'll cover some common techniques which you are likely to use when processing survey data. We'll be using real data from two different surveys. The DASS-21 is a 21-item scale for measuring depression, anxiety and stress. The State Self-Esteem Scale (SSES) is a 20-item survey used to measure short-lived (state) changes in self-esteem.

<a name="start"></a>

# Getting started

Create a new R project and upload the files `dass21.csv` and `state-self-esteem.sav`, which you will find in the git repository we used [previously](preproc.html#load).

FIXME <span style="color: red;">Add data sets to rminr-data</span>

```{r init-load, message=FALSE}
## Clear the environment
rm(list = ls())
library(tidyverse)
```

<a name="preprocessing"></a>

# Preprocessing

Many software packages can be used to collect survey data. These include [JISC](https://www.jisc.ac.uk/), [Gorilla Survey](https://gorilla.sc/), [OpenSesame](https://osdoc.cogsci.nl/),

TODO any more...?

Most of these packages will allow you to save the survey data as a CSV file. The precise structure of the data varies between packages, so you are likely to have to start by preprocessing your data. Here we'll cover the preprocessing tasks you're likely to need when working with survey data. These build on the principles and programming techniques described in the [preprocssing worksheet](preproc.html).

## Loading data

We'll start by preprocessing the DASS-21 data, which is a wide format (one row per participant) CSV file.

```{r pre-process-dass}
dass21_raw <- read_csv("dass21.csv") %>%
  select(partID, Age:DASS21)
```

**Explanation of command** - We read the CSV file using `read.csv` and pipe the data into a `select` command, which picks just the columns we want, saving the results in `dass21_raw`. In the `select`, we include the participant ID using `partID`. To avoid having to type out long lists of column names, `select` also allows you to specify ranges of columns which are consecutive in a data frame by specifying the first and last column (left to right), separated by a `:`. In this case we use `Age:DASS21` to select all columns between `Age` and `DASS21`.

## Handling missing data

If participants don't complete a survey, you will want to exclude their data from your analyses. If we look at a section of the DASS-21 data, we can see some that data is missing for some participats.

```{r missing}
slice(dass21_raw, 73:76)
```

The first thing to notice is that we only have the columns that we selected in the commands above. Participants 108, and 109 (rows 3 and 4) have numbers in all columns, indicating that their data is complete. However, participants 106 and 107 have columns containing the value `NA`, which means these cells in the CSV file were empty. For participant 106, all columns are `NA` (perhaps they dropped out of the study), and for participant 107, all of the DASS-21 columns are `NA` (perphas they skipped this survey).

We can exclude any rows with missing data as follows:

```{r exclude-missing}
dass21 <- dass21_raw %>% drop_na()
```

**Explanation of command** - We pipe the raw data into the `drop_na()` function (part of the `tidyverse` package). This drops any rows with a column containing `NA`. This code would also exclude participants who only partially complete a survey.

## Tidying a data frame

This data was saved from SPSS. R can read SPSS `.sav` files into a data frame using the `read.spss()` function from the `foreign` package.

```{r read-sses}
library(foreign)
sses <- read.spss(paste0('state-self-esteem.sav'), to.data.frame=TRUE)
```

The SSES consists of 20 questions, each of which is scored from 0 (Not at all) to 4 (Extremely).

```{r pre-process-sses}
sses_pre_raw  <- sses %>% select(1, 5:25) %>%
    set_names(~ str_to_lower(.) %>%
                  str_replace_all("pre_sse_", "q")) %>%
  mutate(subj = factor(partid), condition = factor(condition), time = factor('pre')) %>%
  select(subj, condition, time, q1:q20)
sses_pre_raw$condition <- recode_factor(sses_pre_raw$condition, `0` = 'control',
                                        `1` = 'self', `2` = 'other')

sses_post_raw <- sses %>% select(1, 25:45) %>%
      set_names(~ str_to_lower(.) %>%
                  str_replace_all("post_sse_", "q")) %>%
  mutate(subj = factor(partid), condition = factor(condition), time = factor('post')) %>%
  select(subj, condition, time, q1:q20)
sses_post_raw$condition <- recode_factor(sses_post_raw$condition, `0` = 'control',
                                        `1` = 'self', `2` = 'other')

```

<a name="reverse"></a>

# Reverse score survey

Explain reverse coding.

Some surveys have some reverse coded items because...

```{r reverse}
# Reverse score survey items
# @param scores raw scores
# @param reverse character vector of columns to be reverse scored
# @param max integer value of maximum score
reverse_score_survey <- function(scores, reverse, max) {
  reverse_score <- function(score) { max - score } # for scores which start at 0, for starting at 1, max + 1 - score
  scores %>% mutate_at(reverse, reverse_score)
}

reverse_questions <- c('q2', 'q4', 'q5', 'q7', 'q8', 'q10', 'q13', 'q15', 'q16', 'q17', 'q18',
                       'q19', 'q20')
sses_pre <- sses_pre_raw %>%
  group_by(condition) %>%
  group_modify(~ reverse_score_survey(.x, reverse_questions, 4)) %>%
  ungroup()
sses_post <- sses_post_raw %>%
  group_by(condition) %>%
  group_modify(~ reverse_score_survey(.x, reverse_questions, 4)) %>%
  ungroup()
```

<a name="score"></a>

# Calculate a total score for pre and post

We'll also be using data from an experiment which explored mental imagery and self-esteem. 

```{r score}
sses_pre <- sses_pre %>% mutate(total = rowSums(.[4:23]))
sses_pre %>%
  group_by(condition) %>%
  summarise(mean = mean(total), sd = sd(total))

sses_post <- sses_post %>% mutate(total = rowSums(.[4:23]))
sses_post %>%
  group_by(condition) %>%
  summarise(mean = mean(total), sd = sd(total))
```

## TODO Could show how to calculate subscale scores using DASS-21?

DASS-21 came from the tech office with subscale scores already calculated.

<a name="cronbach"></a>

# Calculate Cronbach’s alpha

```{r cronbach}
library(psy)

#TODO overall alpha

sses_cronbach <- function(scores) {
  cronbach <- cronbach(select(scores,q1:q20))
  data.frame(cronbach$alpha)
}

sses_pre_cronbach <- sses_pre %>%
  group_by(condition) %>%
  group_modify(~ sses_cronbach(.x))
sses_pre_cronbach

sses_post_cronbach <- sses_post %>%
  group_by(condition) %>%
  group_modify(~ sses_cronbach(.x))
sses_post_cronbach
```

<a name="baseline"></a>

# Compare baseline SSES scores between conditions

* one-way ANOVA
* hope not to find differences

```{r baseline}
library(BayesFactor, quietly = TRUE)
# FIXME: in base::try(expression, silent = silent) : not enough observations
bf <- anovaBF(formula = total ~ condition + subj, data = sses_pre, whichRandom = 'subj')
bf <- anovaBF(formula = total ~ condition, data = sses_pre)
bf
```

<a name="prepost"></a>

# Pre-post

* Within-between ANOVA sses ~ time*condition
* time is the repeated measures factor
* condition is the between-subjects factor

```{r prepost}

# FIXME: Is there a better way to combine time avoiding 'Unequal factor levels: ... ' warning
sses_pre_post <- bind_rows(sses_pre, sses_post) %>%
  mutate(time = factor(time))

bf <- anovaBF(formula = total ~ time*condition + subj,
              data = sses_pre_post, whichRandom = 'subj')

bf
bf[1]         # condition
bf[2]         # time
bf[4] / bf[3] # condition * time
```

* TODO <span style="color: red;">Given that there's an interaction, how much should we say about [pairwise comparisons](https://ajwills72.github.io/rminr/anova1.html#pairs)?</span>

# References

Heatherton, T. F., & Polivy, J. (1991). Development and validation of a scale for measuring state self-esteem. _Journal of Personality and Social Psychology, 60(6)_, 895.

Osman, A., Wong, J. L., Bagge, C. L., Freedenthal, S., Gutierrez, P. M., & Lozano, G. (2012). The Depression Anxiety Stress Scales—21 (DASS-21): Further Examination of Dimensions, Scale Reliability, and Correlates. _Journal of Clinical Psychology, 68(12)_, 1322–1338. https://doi.org/10.1002/jclp.21908

___

This material is distributed under a [Creative Commons](https://creativecommons.org/) licence. CC-BY-SA 4.0. 

