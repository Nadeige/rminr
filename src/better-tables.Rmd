---
title: "Better tables"
author: "Paul Sharpe, Andy Wills"
output: html_document
---

```{r setup, include=FALSE}
## DEVELOPERS: Uncomment one option, as appropriate

## Data required to knit
## https://github.com/ajwills72/rminr-data/tree/master/going-further/picture-naming.csv
## https://github.com/ajwills72/rminr-data/tree/master/case-studies/jon-may/big5_total.csv
##
## I check out rminr-data and make a symbolic link to going-further

## Show only commands.
## knitr::opts_chunk$set(echo = TRUE, message = FALSE, results='hide', fig.keep = 'none', comment=NA)

## Show commands and output.
knitr::opts_chunk$set(echo = TRUE, comment=NA, cache = TRUE)
library(pander)
library(tidyverse)
```

## Contents

- [Introduction](#intro)

- [Getting started](#start)

- [Creating a correlation matrix](#cor-matrix)

- [Exercise 1](#ex1)

- [Creating a custom table of descriptive statistics](#descriptives)

- [Exercise 2](#ex2)

- [R Markdown](#rmd)

<a name="intro"></a>

## Introduction

It can be helpful to present data in tables, rather than text, especially when you need to refer to the same data in different parts of a report. Although tables can be produced manually using a word processor, generating them directly from your data ensures they are up-to-date, and reduces copy-paste errors. This worksheet explains how to use `R` to produce some of the types of table used to report psychological research.

<a name="start"></a>

## Getting started

To prepare for this worksheet:

1. Open the `rminr-data` project we used [previously](preproc.html#load).

1. If you don't see a folder named `going-further`, it means you created your project _before_ the data required for this worksheet was added to the `rminr-data` git repository. You can get the latest files by asking git to "`pull`" the repository. Select the `Git` tab, which is located in the row of tabs which includes the `Environment` tab. Click the `Pull` button with a downward pointing arrow. A window will open showing the files which have been pulled from the repository. Close the `Git pull` window.

1. Open the `Files` tab. The `going-further` folder should contain the file `picture-naming-preproc.csv`.

1. Create a script named `tables.R` in the `rminr-data` folder (the folder above `going-further`). Add the code to this script as you work through each section of the worksheet.

<a name="cor-matrix"></a>

## Creating a correlation matrix

We'll start by producing a correlation matrix. A correlation matrix shows correlations between all combinations of a set of variables, which is often required in research reports. We'll demonstrate an easy way to produce correlation matrices, with [APA styling](https://apastyle.apa.org/style-grammar-guidelines/tables-figures/tables), in a format that can be read by Microsoft Word or LibreOffice Writer. A similar approach can be used to produce other common table types.

We'll generate a correlation matrix using the `attitude` dataset, which is included with `R`. These data are the percentage of favourable attitudes given by employees, in relation to seven questions regarding their department (you can find out a bit more about these data by typing `?attitude`). Here are the first few rows of the data frame:

```{r, echo=FALSE}
attitude %>% head(5) %>% pander()
```

We'll use the `apaTables` package to generate the correlation matrix.

```{r, R.options = list(width = 10000)}
rm(list = ls()) # clear the environment
library(apaTables)
apa.cor.table(attitude, filename="table1.doc", table.number = 1)
```

**Explanation of commands:**

We load the `apaTables` package.The function to generate a correlation matrix is `apa.cor.table()`. We pass the `attitude` data frame as the first argument, and use `filename` to specify that the output should be saved in the file `table1.doc`. The `table.number` argument sets the number in the table heading output, in this case "Table 1". If you omit this argument, the text will be "Table XX".

**Explanation of output:**

[Export](https://ajwills72.github.io/rminr/using-projects.html#download) `table1.doc` from RStudio and open it using a word processor

The first thing to notice is that the styling (spacing, use of italics, horizontal lines, positioning of captions and footnotes etc.) complies with the APA guidelines for tables. 

The table number and caption is above the table itself - you will need to edit the caption by hand to make it more meaningful, for example "Means, standard deviations, and correlations with confidence intervals, for the attitude measures of Study 1".

The `Variable` column contains a number and the column name for the seven attitude variables. The next two columns show the mean and standard deviation for each variable. The remaining columns use the numbers from items in the `Variable` column as headings, indicating that they refer to the same variable. The cells show the correlation between the column variables and each of the variables in the rows. Cells are left empty where a variable would otherwise be correlated with itself. The 95% [confidence interval](https://ajwills72.github.io/rminr/more-on-t.html) for the correlation is shown in square brackets.

For example, the correlation between `rating` and `complaints` in this sample is .83. The confidence interval indicates that the population value is likely to be between .66 and .91. 

Evidence for the correlation is calculated using traditional statistics, rather than the Bayes factors described in the [Relationships, part 2 worksheet](corr.html). One asterisk (`*`) indicates `p < .05`. Two asterisks (`**`) signify `p < .01`. These calculations assumed a two-tailed test; one-tailed tests for correlations are explained in the [More on relationships, part 2](corr-extended.html) worksheet. Also recall that p-values are [widely misinterpreted](evidence.html#p-wrong), so it would be better to edit this part of the table by hand to reflect [Bayes Factors](corr.html#evidence) you have already calculated. We suggest using `*` for BF > 3, `**` for BF > 10, `o` for BF < 0.33, and `oo` for BF < 0.1. Change the text at the bottom of the table accordingly.

<a name="ex1"></a>

## Exercise 1

For this exercise, we'll load some data from a study which measured aspects of participants' personality.

```{r}
# Exercise 1
library(tidyverse)
big5 <- read_csv('case-studies/jon-may/big5_total.csv')
```

The first few rows show that the scale used measured the 'big 5' personality factors; openness to experience, conscientiousness, extraversion, agreeableness and neuroticism (OCEAN).

```{r, echo=FALSE}
big5 %>% head(5) %>% pander()
```

Create a correlation matrix for the five personality factors. Number the table as "Table 2", and save the results in `table2.doc`. Your table should look like this in Rstudio:

```{r ex1, echo=FALSE, R.options = list(width = 10000)}
apa.cor.table(big5 %>% select(-subj), filename='table2.doc', table.number = 2)
```

...and it should be APA formatted in the file `table2.doc`. 

**Copy the R code you used for this exercise into PsycEL**

<a name="descriptives"></a>

## Creating a custom table of descriptive statistics

As with graphs, there is often an element of design involved in presenting tabular data in a format most useful for your reader. Packages like `apaTables` are useful for producing APA tables where there is a standard way to present data. However, you often need a table which is customised to present your data in the most useful format. The cost of custom tables is that the content requires a little more preprocessing, and styling the table according to APA standards will require some hand-formatting in your wordprocessor.

We'll demonstrate this process by producing a table of descriptive statistics. The data we'll use comes from an experiment which evaluated childrenâ€™s language development using the Words in Game (WinG) test. WinG consists of a set of picture cards which are used in four tests: noun comprehension, noun production, predicate comprehension, and predicate production. The Italian and English versions of the WinG cards use different pictures to depict the associated words. The experiment tested whether English-speaking children aged approximately 30 months, produce similar responses for the two sets of cards. We would like to produce a single table, containing descriptive statistics for all four tests.

We start by loading the data:

```{r excel, message=FALSE}
# Table of descriptive statistics
wing_preproc <- read_csv('going-further/picture-naming-preproc.csv')
```

The first few rows of `wing_preproc` look like this:

```{r, echo=FALSE}
wing_preproc %>% head() %>% pander(split.table = Inf)
```

### Table of descriptives

Our test scores are currently in _wide_ format (lots of columns, few rows), but R generally requires data to be in _long_ format 
(lots of rows, few columns). This means we first have to make the data frame wider, so we can calculate summary statistics.

```{r pivot}
# wide to long
task_by_subj <- wing_preproc %>%
  pivot_longer(cols = c(nc, np, pc, pp),
               names_to = 'task',
               values_to = 'correct') %>%
  select(subj, gender, cards, task, correct)
```

**Explanation of command:**

In the [Within-subject differences worksheet](#anova1.html), you learnt how to use `pivot_wider()` to widen long data frames. The `pivot_longer()` command does the reverse. `cols = c(nc, np, pc, pp)` selects the columns we want to pivot. Each value in these columns is added to a row in a new column called `correct` (`values_to = 'correct'`). In the same row, a new column `task` is set to the name of the column which the value came from (`names_to = 'task'`). Because `task` is a factor, this turns the pivoted column names into factor levels associated with the corresponding value in `correct`. All of the values in the other columns are duplicated for each row. We `select()` just the columns we want for our table of descriptive statistics.

The first few rows of `task_by_subj` look like this:

```{r echo=FALSE}
task_by_subj %>% head(5) %>% pander()
```

Now we can calculate some summary statistics:

```{r descriptives-1}
descriptives <- task_by_subj %>%
  group_by(task, gender) %>%
  summarise(mean = mean(correct, na.rm = TRUE), sd = sd(correct, na.rm = TRUE)) %>%
  mutate(across(where(is.numeric), ~ sprintf("%.2f", round(.x, 2))))
```

**Explanation of commands:**

1. We group `task_by_subject` by gender within task and use `summarise` to calculate a mean and standard deviation for each group. We need to include `na.rm = TRUE` as we have some cells containing `NA` for children who didn't complete a particular test.
1. The final line formats the numbers in the data frame. We'll explain the command in steps. You already know that `mutate()` changes data in a data frame. Here we use `across()`, to apply a function to a subset of columns. We specify that we want to apply the function to just the numeric columns with `where(is.numeric)`. The second argument to `across()` is the function used to modify the column values. In this case, `round(.x, 2)`, means round the column values (`.x`) to 2 decimal places. Finally we ensure that all numbers have 2 digits after the decimal point. The `"%.2f"` argument tells `sprintf()` to ensure all numbers have 2 digits after the decimal point, adding 0s where necessary. The second argument is the result of `round()`.

Formatting the numbers in this way makes it easy to put the digits in the correct position relative to the decimal point when laying out your table, by selecting the numeric columns and using "align right" in your word processor.

Our data now looks like this:

```{r echo=FALSE}
descriptives %>% pander()
```

We'll do a little more formatting in prepration for producing the table:

```{r descriptives-2}
descriptives_table <- descriptives %>%
  pivot_wider(names_from = gender, values_from = c(mean, sd)) %>%
  mutate(task = factor(task))
```

**Explanation of commands:**

1. We `pivot_wider()` so that rows contain the test codes, and columns contain the mean and standard deviation by gender.
1. We make `task` a factor.

```{r echo=FALSE}
descriptives_table %>% pander()
```

Finally we make the column names and values more meaningful for our readers:

```{r descriptives-3}
descriptives_table <- descriptives_table %>%
  unite("male", c('mean_male','sd_male'), sep=' (') %>%
  unite("female", c('mean_female','sd_female'), sep=' (') %>%
  mutate(male = paste0(male, ')'), female = paste0(female, ')'))
descriptives_table$task = recode_factor(descriptives_table$task,
                                        nc = 'Noun Comprehension',
                                        np = 'Noun Production',
                                        pc = 'Predicate Comprehension',
                                        pp = 'Predicate Production')
```

1. `unite("male", c('mean_male','sd_male'), sep=' (')` converts the `mean_male` and `sd_male` column values to a column `male` separated by ` (`.
1. We do the same for the `mean_female` and `sd_female` columns.
1. `mutate(male = paste0(male, ')'), female = paste0(female, ')'), task = factor(task))` adds the trailing `)` to the `male` and `female` columns and converts `task` to a factor.
1. We recode `task` factor levels to more meaningful strings.

We're now ready to print our table. There are numerous `R` packages for presenting data as tables. We've chosen to the `kableExtra` package, as it's capable of producing almost any table you might need in your reports. The tables produced by kableExtra are in [HTML format](https://haozhu233.github.io/kableExtra/awesome_table_in_html.html), which means you can simply copy-paste them into Microsoft Word or LibreOffice Writer.

```{r kable-descriptives}
library(kableExtra)
descriptives_table %>% kable(
  col.names = c('Task', 'Male', 'Female'), booktabs = TRUE) %>%
  kable_styling()
```

**Explanation of commands:**

1. `library(kableExtra)` loads the package containing the `kable()` function.
1. We pipe our data into `kable()` using `col.names` to create neater column headings, and `kable_styling()` to produce a tidy HTML table.

Try copying the table into your word processor now. In the **Viewer** pane, select all of the rows and columns in the table, then right-click and select `Copy`. Open your word processor and select `Paste`.

<a name="ex2"></a>

## Exercise 2

Starting with the data in `task_by_subj`, generate a table of descriptive statistics showing task accuracy for the Italian and English cards. Print the results using `kable()`. They should look like this:

```{r ex2-1, echo=FALSE}
descriptives_by_cards <- task_by_subj %>%
  group_by(task, cards) %>%
  summarise(mean = mean(correct, na.rm = TRUE), sd = sd(correct, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(across(where(is.numeric), ~ sprintf("%.2f", round(.x,2))))

by_cards_table <- descriptives_by_cards %>%
  pivot_wider(names_from = cards, values_from = c(mean, sd))

by_cards_table <- by_cards_table %>%
  unite("english", c('mean_english','sd_english'), sep=' (') %>%
  unite("italian", c('mean_italian','sd_italian'), sep=' (') %>%
  mutate(english = paste0(english, ')'), italian = paste0(italian, ')'), task = factor(task),
         task = recode_factor(.$task, nc = 'Noun Comprehension', np = 'Noun Production',
                                  pc = 'Predicate Comprehension', pp = 'Predicate Production'))

by_cards_table %>%
  kable(col.names = c('Task', 'English', 'Italian')) %>%
  kable_styling()
```

**Copy the R code you used for this exercise into PsycEL.**

<a name="rmd"></a>

## R Markdown

You can avoid copy-pasting tables (and all other analyses) by writing your reports using `R Markdown` instead of a word processor. `R Markdown` is a language for writing documents which include `R` code. The code is run, and the output is included in the document. `R Markdown` can be used to produce different types of document (e.g. reports, presentations, web pages), in various formats (e.g. Microsoft Word, PDF, HTML). The `Research Methods in R` worksheets are written using `R Markdown`, and although we don't teach it in these materials, there are other [courses](https://rmarkdown.rstudio.com/lesson-1.html) which make it easy to learn.

___

This material is distributed under a [Creative Commons](https://creativecommons.org/) licence. CC-BY-SA 4.0. 

