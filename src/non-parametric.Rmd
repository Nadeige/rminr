---
title: "Traditional non-parametric tests"
author: "Paul Sharpe"
output: html_document
---

```{r setup, include=FALSE}
## DEVELOPERS: Uncomment one option, as appropriate

## Show only commands.
## knitr::opts_chunk$set(echo = TRUE, message = FALSE, results='hide', fig.keep = 'none', comment=NA)

## Mann-Whitney based on https://stackoverflow.com/questions/43033884/r-mann-whitney-u-test-output-like-in-spss
##
## Show commands and output.
knitr::opts_chunk$set(echo = TRUE, comment=NA, cache = TRUE)
library(pander)
```

## Contents

- [Introduction](#intro)

- [Getting started](#start)

- [Loading and preprocessing data](#load)

- [Calculating summary statistics](#summary)

- [Mann-Whitney U test](#wilcox)

- [Exercise 1](#ex1)

- [Kruskal-Wallis test](#kruskal-wallis)

<a name="intro"></a>

## Introduction

This worksheet describes common, traditional (frequentist) non-parametric statistical tests. The statistical tests used to analyse differences and relationships in other worksheets are collectively known as **parametric tests**. For their results to be valid, parametric tests require that the data being analysed comes from a population with a particular probability distribution, having known parameters. In most cases, the probability distribution is the normal (Gaussian) distribution, and the parameters are the mean and standard deviation. **Non-parametric tests** do not rely on meeting these assumptions, and can therefore be used to analyse data which is not normally distributed. Parametric tests make some additional assumptions which aren't discussed in this worksheet. Our aim is to give an overview of these two categories of statistical tests to help you decide which test is most appropriate for analysing your data.

If your data meet the criteria for a parametric test, this is the best choice as parametric tests normally provide greater [statistical power](power.html) than the equivalent non-parametric test. When you learnt about the central limit theorem, you saw that a large enough sample will have a normal distribution, regardless of the distribution of the underlying data from which it was sampled. Given the size of most effects in psychology, to reliably detect differences between conditions would require sample sizes which ensure that the data is normally distributed (about 30 and above). Therefore, the most likely scenario in which you would use a _non-parametric test_ is when you have a small sample, and the data is not normally distributed.

Many non-parametric tests work by ranking data values from lowest to highest, and performing a test on the ranks, rather than the values themselves. This avoids the disproportional effect that outlier values have on the mean, one of the key parameters in parametric tests.

<a name="start"></a>

## Getting started

To prepare for this worksheet:

1. Open the `rminr-data` project we used [previously](preproc.html#load).

1. If you don't see a folder named `going-further`, it means you created your project _before_ the data required for this worksheet was added to the `rminr-data` git repository. You can get the latest files by asking git to "`pull`" the repository. Select the `Git` tab, which is located in the row of tabs which includes the `Environment` tab. Click the `Pull` button with a downward pointing arrow. A window will open showing the files which have been pulled from the repository. Close the `Git pull` window.

1. Open the `Files` tab. The `going-further` folder should contain the file `picture-naming-preproc.csv`.

1. Create a script named `non-parametric.R` in the `rminr-data` folder (the folder above `going-further`). Add the code to this script as you work through each section of the worksheet.

<a name="load"></a>

## Loading and preprocessing data

We'll demonstrate the Mann-Whitney U test using data from an experiment which evaluated childrenâ€™s language development using the Words in Game (WinG) test. WinG consists of a set of picture cards which are used in four tests: noun comprehension, noun production, predicate comprehension, and predicate production. The Italian and English versions of the WinG cards use different pictures to depict the associated words. The experiment tested whether English-speaking children aged approximately 30 months, produce similar responses for the two sets of cards.

We start by loading the data:

```{r load, message=FALSE}
rm(list = ls()) # clear the environment
library(tidyverse)

# Table of descriptive statistics
wing_preproc <- read_csv('going-further/picture-naming-preproc.csv',
                         col_types = 'fffiiiiiiiiii')
```

```{r, echo=FALSE}
wing_preproc %>% head(12) %>% pander(split.table = Inf)
```

Our test scores are currently in wide format, but we need them in long format to perform the tests.

```{r pivot}
# wide to long
task_by_subj <- wing_preproc %>%
  pivot_longer(cols = c(nc, np, pc, pp),
               names_to = 'task',
               values_to = 'correct') %>%
  select(subj, gender, cards, task, correct)
```

**Explanation of command:**

In the [Within-subject differences worksheet](#anova1.html), you learnt how to use `pivot_wider()` to widen long data frames. The `pivot_longer()` command does the reverse. `cols = c(nc, np, pc, pp)` selects the columns we want to pivot. Each value in these columns is added to a row in a new column called `correct` (`values_to = 'correct'`). In the same row, a new column `task` is set to the name of the column which the value came from (`names_to = 'task'`). Because `task` is a factor, this turns the pivoted column names into factor levels associated with the corresponding value in `correct`. All of the values in the other columns are duplicated for each row. We `select()` just the columns we want for our table of descriptive statistics.

<a name="summary"></a>

## Calculating summary statistics

The Mann-Whitney test compares _ranked_ data, so we should report the median (rather than the mean) as our summary statistic. We'll also calculate the sum and mean of the ranks, as these are sometimes reported.

```{r}
nc_include <- task_by_subj %>% filter(task == 'nc') %>% drop_na()
nc_include <- nc_include %>% mutate(rank = rank(correct))
nc_summary <- nc_include %>%
  group_by(cards) %>%
  summarise(n = n(),
            median = median(correct),
            mean_rank = mean(rank),
            sum_rank = sum(rank))
nc_summary
```

**Explanation of commands:**

1. `task_by_subj %>% filter(task == 'nc')` selects rows containing data for the noun comprehension task.
1. In the preprocessed data, subjects whose data was excluded for a task have the value `NA` in the `correct` column. We exclude these rows using `drop_na()`.
1. We rank the scores in both groups using `rank(correct)` and put the rankings in `rank` using `mutate()`.
1. Finally, we group the data by `cards`, and use `summarise`, to calculate the number of children in each group `n()`, the `median()` score, `mean(rank)` and `sum(rank)`.

**Explanation of output:**

<a name="wilcox"></a>

## Mann-Whitney U test

The Mann-Whitney U test (also known as the Wilcoxon rank sum test) is a non-parametric equivalent of a between-subjects t-test.  It works by ranking all of the scores in the two groups, adding the ranks in each group, and comparing these "summed ranks" to determine if they differ.

We'll run a Mann-Whitney U test to see if there were any differences between scores for the Italian and English cards on the noun comprehension (`nc`) task.

```{r mw-nc}
# Mann-Whitney U for noun comprehension
nc_u <- wilcox.test(correct ~ cards, nc_include)
nc_u
```

```{r, echo=FALSE, eval=FALSE}
# calculations for additional stats reported by SPSS
# Field(2013, p.217ff is good on this)
# z is useful for calculating r as an effect size
# See also: https://data.library.virginia.edu/the-wilcoxon-rank-sum-test/
n1 <- sum(as.integer(nc_include$cards) == 1)
wilcox.test(correct ~ cards, nc_include) %>%
    with(tibble(U = statistic,
                W = statistic + n1 * (n1 + 1) / 2,
                Z = qnorm(p.value / 2),
                p = p.value))
```

**Explanation of commands:**

In `R`, `wilcox.test()`, with the argument `paired = FALSE` (the default) is the same as a Mann-Whitney U test. The command `wilcox.test(correct ~ cards, nc_include)` runs the test to compare the `correct` scores for the Italian and English `cards`.

**Explanation of output:**

The string `correct by cards` reminds you that you compared the values in `correct` between the levels in the `cards` factor. When calling `wilcox.test()` with `paired = FALSE`, the value of `W` is equivalent to `U`. The `p` value tells us whether there was  a significant difference between the medians in the two groups. The string `alternative hypothesis: true location shift is not equal to 0`, is another way of saying that the distribution of one of the groups is shifted to the left or right of the other. If the `p` value is > .05, we'll accept the null hypothesis that there's no difference between the distributions. The warning `cannot compute exact p-value with ties` lets you know that the method used to calculate _p_ will not be exact, because some items in the Italian and English scores had identical rankings.

We now have all of the information we need to report the results. For the noun comprehension task, there was no significant difference in accuracy between the Italian (_Mdn_ = `r nc_summary[nc_summary$cards == 'italian', 'median']`) and English (_Mdn_ = `r nc_summary[nc_summary$cards == 'english', 'median']`) cards (_U_ = `r nc_u$statistic`, _p_ = `r round(nc_u$p.value, 2)`).

<a name="ex1"></a>

## Exercise 1

Calculate summary statistics and Mann-Whitney U for the noun production task. Your results should look like this:

```{r ex1, echo=FALSE}
np_include <- task_by_subj %>% filter(task == 'np') %>% drop_na()
np_include <- np_include %>% mutate(rank = rank(correct))
np_include %>%
  group_by(cards) %>%
  summarise(n = n(),
            median = median(correct),
            mean_rank = mean(rank),
            sum_rank = sum(rank))
wilcox.test(correct ~ cards, np_include)
```

**Copy the R code you used for this exercise into PsycEL.**

<a name="kruskal-wallis"></a>

## Kruskal-Wallis test

http://www.sthda.com/english/wiki/kruskal-wallis-test-in-r

"Kruskal-Wallis test by rank is a non-parametric alternative to one-way ANOVA test, which extends the two-samples Wilcoxon test in the situation where there are more than two groups. Itâ€™s recommended when the assumptions of one-way ANOVA test are not met. This tutorial describes how to compute Kruskal-Wallis test in R software."

___

This material is distributed under a [Creative Commons](https://creativecommons.org/) licence. CC-BY-SA 4.0.